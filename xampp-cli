#!/bin/bash
#
# XAMPP-CLI
# ------------------------
# Command line interface for a XAMPP
# 
# Based on XAMPP (XAMPP Starter) by Ziyaddin Sadigov:
# http://github.com/ziyaddin/xampp
# 
# Author: Denys Dovhan (email@denysdovhan.com)
# 


# Default commands
DEFAULT_COMMANDS="
  start  startapache  startmysql  startftp
  stop   stopapache   stopmysql   stopftp 
  reload reloadapache reloadmysql reloadftp
  backup restart      security    oci8
  enablessl disablessl"

# Check if user have sudo access
# Usage: check_sudo
function check_sudo {
  if [ "$EUID" -ne 0 ]; then
    echo "(!)You need to be root to perform this action."
    exit
  fi
}

# Add new host to vhosts.conf
# Usage: add_host <domain> <projectDir>
function add_host {
  check_sudo
  # If the directory doesn't exist, create it
  if [[ ! -d $2 ]]; then echo "Make directory $2." && mkdir $2; fi;
  # Make link from `projectDir` to `htdocs/projectDir`
  ln -s `(cd $2 && pwd)` /opt/lampp/htdocs/$1

  echo "Please answer some questions or confirm default values:"
  read -p "ServerAdmin (admin@$1): " ADMIN
  read -p "ErrorLog (logs/$1-error_log): " ERROR_LOG
  read -p "CustomLog (logs/$1-access_log): " ACCESS_LOG

  # If variables aren`t entered, set default values
  : ${ADMIN:="admin@$1"}
  : ${ERROR_LOG:="logs/$1-error_log"}
  : ${ACCESS_LOG:="logs/$1-access_log"}

  printf "
<VirtualHost *:80>
\tServerAdmin $ADMIN
\tDocumentRoot \"/opt/lampp/htdocs/$1\"
\tServerName $1
\tServerAlias www.$1
\tErrorLog \"$ERROR_LOG\"
\tCustomLog \"$ACCESS_LOG\" common
</VirtualHost>" >> /opt/lampp/etc/extra/httpd-vhosts.conf

  echo "127.0.1.1 $1" >> /etc/hosts

  echo "New host $1 from the directory $2 has been successfully added."
}


# Check if arguments entered
if [[ ! -z $1 ]]; then

  # If entered argument are default commands, execute them
  if [[ $DEFAULT_COMMANDS =~ $1 ]]; then
    /opt/lampp/lampp $1

  # For `gui` run xampp-manager with gksu
  # If this command has been started with sudo privileges, open the manager without gksu 
  elif [[ $1 == "gui" ]]; then
    gksu /opt/lampp/manager-linux*.run &

  # Command for adding new hosts
  # Usage: sudo xampp add <domain> <projectDir>
  elif [[ $1 == "add" ]]; then
    # Check entered arguments
    case $# in
      3 ) # sudo xammpp add <domain> <projectDir>
        add_host $2 $3
        ;;
      2 ) # sudo xampp add <domain>
        add_host $2 $2
        ;;
      * ) # Wrong number of arguments
        echo "Wrong number of arguments have been entered."
        exit
        ;;
    esac

  else
    echo "Else case"
  fi

# If arguments aren't entered, output help
else
  echo "
Usage: xampp <command>

  start         Start XAMPP (Apache, MySQL and eventually others)
  startapache   Start only Apache
  startmysql    Start only MySQL
  startftp      Start only ProFTPD

  stop          Stop XAMPP (Apache, MySQL and eventually others)
  stopapache    Stop only Apache
  stopmysql     Stop only MySQL
  stopftp       Stop only ProFTPD

  reload        Reload XAMPP (Apache, MySQL and eventually others)
  reloadapache  Reload only Apache
  reloadmysql   Reload only MySQL
  reloadftp     Reload only ProFTPD

  enablessl     Enable SSL support for Apache
  disablessl    Disable SSL support for Apache

  restart       Stop and start XAMPP
  security      Check XAMPP's security
  backup        Make backup file of your XAMPP config, log and data files
  oci8          Enable the oci8 extenssion

  gui           Graphic interface for XAMPP
"
fi